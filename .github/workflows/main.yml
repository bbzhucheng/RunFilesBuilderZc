#=================================================
# https://github.com/wukongdaily/RunFilesBuilder
# Description: Build Passwall RunFiles using GitHub Actions
# License: MIT
# Author: wukongdaily
#=================================================

name: Make Passwall run files

on:
  workflow_dispatch:

permissions:
  contents: write   # 需要创建 release

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------------------------------
      # 获取 Passwall 最新 tag（不用 GitHub API，避免权限/限流）
      # -------------------------------------------------
      - name: Fetch latest Passwall tag
        run: |
          set -e
          LATEST_TAG=$(git ls-remote --tags https://github.com/xiaorouji/openwrt-passwall.git \
            | awk -F/ '{print $NF}' \
            | grep -v '{}' \
            | sort -V \
            | tail -1)

          echo "LATEST_TAG=$LATEST_TAG"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      # -------------------------------------------------
      # 克隆 makeself
      # -------------------------------------------------
      - name: Clone makeself repository
        run: git clone https://github.com/megastep/makeself.git

      # -------------------------------------------------
      # 下载 Passwall 依赖（使用 latest/download 直链 + 重命名）
      # -------------------------------------------------
      - name: Download latest Passwall files
        run: |
          set -e
          mkdir -p downloads
          cd downloads

          echo "Downloading Passwall packages..."

          # x86_64
          curl -L \
            https://github.com/xiaorouji/openwrt-passwall/releases/latest/download/passwall_packages_ipk_x86_64.zip \
            -o passwall_x86_64.zip

          # aarch64 cortex-a53
          curl -L \
            https://github.com/xiaorouji/openwrt-passwall/releases/latest/download/passwall_packages_ipk_aarch64_cortex-a53.zip \
            -o passwall_aarch64.zip

          # luci 主包
          curl -L \
            https://github.com/xiaorouji/openwrt-passwall/releases/latest/download/luci-app-passwall.ipk \
            -o luci-app-passwall.ipk || true

          # luci 中文包（可能不存在，允许失败）
          curl -L \
            https://github.com/xiaorouji/openwrt-passwall/releases/latest/download/luci-i18n-passwall-zh-cn.ipk \
            -o luci-i18n-passwall-zh-cn.ipk || true

          echo "Downloaded files:"
          ls -lh

      # -------------------------------------------------
      # 整理 x86_64
      # -------------------------------------------------
      - name: Organize files for x86_64
        run: |
          set -e
          mkdir -p passwall_x86_64/depends passwall_x86_64/main
          unzip downloads/passwall_x86_64.zip -d passwall_x86_64/depends
          cp downloads/luci-*.ipk passwall_x86_64/main/ || true

      # -------------------------------------------------
      # 整理 aarch64
      # -------------------------------------------------
      - name: Organize files for aarch64_cortex-a53
        run: |
          set -e
          mkdir -p passwall_aarch64/depends passwall_aarch64/main
          unzip downloads/passwall_aarch64.zip -d passwall_aarch64/depends
          cp downloads/luci-*.ipk passwall_aarch64/main/ || true

      # -------------------------------------------------
      # 生成 install.sh
      # -------------------------------------------------
      - name: Create install.sh scripts
        run: |
          cat <<'EOF' > passwall_x86_64/install.sh
          #!/bin/sh
          set -e
          opkg update
          opkg install iptables-mod-tproxy \
                       iptables-mod-socket \
                       iptables-mod-iprange \
                       iptables-mod-conntrack-extra
          opkg install depends/*.ipk
          opkg install main/*.ipk
          EOF

          chmod +x passwall_x86_64/install.sh
          cp passwall_x86_64/install.sh passwall_aarch64/install.sh

      # -------------------------------------------------
      # 移动到 makeself
      # -------------------------------------------------
      - name: Move passwall directories to makeself
        run: |
          mv passwall_x86_64 makeself/
          mv passwall_aarch64 makeself/

      # -------------------------------------------------
      # 生成 .run 文件
      # -------------------------------------------------
      - name: Create self-extracting packages
        run: |
          cd makeself
          ./makeself.sh passwall_x86_64 \
            passwall_x86_64_${{ env.LATEST_TAG }}.run \
            "Passwall installer (x86_64)" \
            ./install.sh

          ./makeself.sh passwall_aarch64 \
            passwall_aarch64_a53_${{ env.LATEST_TAG }}.run \
            "Passwall installer (aarch64 cortex-a53)" \
            ./install.sh

      # -------------------------------------------------
      # 检查产物
      # -------------------------------------------------
      - name: Check file sizes
        run: |
          ls -lh makeself/*.run

      # -------------------------------------------------
      # 创建 Release
      # -------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.LATEST_TAG }}
          name: "Passwall ${{ env.LATEST_TAG }}"
          files: makeself/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
